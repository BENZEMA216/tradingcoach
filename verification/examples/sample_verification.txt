====================================================================================================
FIFO 验证报告: TSLL
====================================================================================================

【交易序列】(按时间顺序)

时间                    方向          数量       价格      手续费      累计持仓
----------------------------------------------------------------------------------------------------
2024-09-15 09:30:00    买入          100      $10.50      $2.00        +100
2024-09-16 10:15:00    买入           50      $11.00      $1.50        +150
2024-09-20 14:20:00    卖出          120      $12.50      $2.40         +30
2024-09-25 11:00:00    卖出           30      $12.00      $0.90          0

【FIFO匹配过程】(手动模拟)

匹配 #1:
  开仓交易: 买入 100 @ $10.50 (2024-09-15 09:30)
  平仓交易: 卖出 120 @ $12.50 (2024-09-20 14:20)
  匹配数量: 100 股

  计算详情:
    进场价格: $10.50
    出场价格: $12.50
    进场手续费: $2.00 (100/100 × $2.00)
    出场手续费: $2.00 (100/120 × $2.40)
    盈亏: ($12.50 - $10.50) × 100 = $200.00
    净盈亏: $200.00 - $2.00 - $2.00 = $196.00
    盈亏率: 18.67%
    持仓天数: 5 天

匹配 #2:
  开仓交易: 买入 50 @ $11.00 (2024-09-16 10:15)
  平仓交易: 卖出 120 @ $12.50 (2024-09-20 14:20) [剩余20股]
  匹配数量: 20 股

  计算详情:
    进场价格: $11.00
    出场价格: $12.50
    进场手续费: $0.60 (20/50 × $1.50)
    出场手续费: $0.40 (20/120 × $2.40)
    盈亏: ($12.50 - $11.00) × 20 = $30.00
    净盈亏: $30.00 - $0.60 - $0.40 = $29.00
    盈亏率: 13.18%
    持仓天数: 4 天

【未平仓持仓】
  买入 30 @ $11.00 (2024-09-16)

匹配 #3:
  开仓交易: 买入 50 @ $11.00 (2024-09-16 10:15) [剩余30股]
  平仓交易: 卖出 30 @ $12.00 (2024-09-25 11:00)
  匹配数量: 30 股

  计算详情:
    进场价格: $11.00
    出场价格: $12.00
    进场手续费: $0.90 (30/50 × $1.50)
    出场手续费: $0.90 (30/30 × $0.90)
    盈亏: ($12.00 - $11.00) × 30 = $30.00
    净盈亏: $30.00 - $0.90 - $0.90 = $28.20
    盈亏率: 8.55%
    持仓天数: 9 天

【数据库持仓记录对比】

#    Position ID   数量     进场价     出场价      净盈亏      状态      验证
----------------------------------------------------------------------------------------------------
1    734          100    $10.50    $12.50    $196.00    已平仓   ✓ 匹配
2    735           20    $11.00    $12.50     $29.00    已平仓   ✓ 匹配
3    736           30    $11.00    $12.00     $28.20    已平仓   ✓ 匹配

【验证结果】
✅ 通过
- FIFO顺序: ✓
- 数量匹配: ✓
- 价格匹配: ✓
- 手续费分配: ✓
- 盈亏计算: ✓

====================================================================================================

关键验证点说明:

1. FIFO顺序验证:
   - 第一次卖出(120股)首先匹配了最早的买入(100股 @ $10.50)
   - 剩余20股继续匹配第二次买入(50股 @ $11.00)的前20股
   - 第二次卖出(30股)匹配了第二次买入的剩余30股
   ✅ 严格按照先进先出顺序

2. 手续费分配验证:
   - 第一个持仓(100股):
     进场: 100/100 × $2.00 = $2.00 ✓
     出场: 100/120 × $2.40 = $2.00 ✓

   - 第二个持仓(20股):
     进场: 20/50 × $1.50 = $0.60 ✓
     出场: 20/120 × $2.40 = $0.40 ✓

   - 第三个持仓(30股):
     进场: 30/50 × $1.50 = $0.90 ✓
     出场: 30/30 × $0.90 = $0.90 ✓

   手续费总计检查:
   进场总费用: $2.00 + $1.50 = $3.50
   分配总计: $2.00 + $0.60 + $0.90 = $3.50 ✓

   出场总费用: $2.40 + $0.90 = $3.30
   分配总计: $2.00 + $0.40 + $0.90 = $3.30 ✓

3. 盈亏计算验证:
   - 公式: (出场价 - 进场价) × 数量 - 总手续费
   - 持仓1: ($12.50 - $10.50) × 100 - $4.00 = $196.00 ✓
   - 持仓2: ($12.50 - $11.00) × 20 - $1.00 = $29.00 ✓
   - 持仓3: ($12.00 - $11.00) × 30 - $1.80 = $28.20 ✓

4. 数量守恒验证:
   买入总量: 100 + 50 = 150 股
   卖出总量: 120 + 30 = 150 股
   持仓总量: 100 + 20 + 30 = 150 股
   ✅ 数量守恒

====================================================================================================

此示例展示了一个典型的部分成交场景:
- 两次买入 (100股 + 50股)
- 两次卖出 (120股 + 30股)
- 生成三个持仓，严格按照FIFO顺序匹配
- 手续费按比例正确分配
- 所有计算准确无误

验证结论: ✅ FIFO匹配逻辑完全正确

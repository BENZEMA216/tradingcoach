# FIFO验证工具快速开始指南

## 🚀 5分钟上手

### 1. 进入验证工具目录
```bash
cd verification
```

### 2. 查看所有可验证的股票
```bash
python3 verify_fifo.py --list
```

### 3. 验证单个股票
```bash
python3 verify_fifo.py AAPL
```

输出示例：
```
====================================================================================================
FIFO 验证报告: AAPL
====================================================================================================

【交易序列】(按时间顺序)
时间                  方向        数量    价格      手续费    累计持仓
2024-10-01 09:30:00  买入        100    $150.00    $2.00    +100
2024-10-10 14:20:00  卖出        100    $155.00    $2.00      0

【FIFO匹配过程】(手动模拟)
匹配 #1:
  开仓交易: 买入 100 @ $150.00 (2024-10-01)
  平仓交易: 卖出 100 @ $155.00 (2024-10-10)
  匹配数量: 100 股

【数据库持仓记录对比】
#    Position ID   数量   进场价   出场价   净盈亏    验证
1    1234         100   $150.00  $155.00  $496.00  ✓ 匹配

【验证结果】
✅ 通过
- FIFO顺序: ✓
- 数量匹配: ✓
- 盈亏计算: ✓
```

### 4. 详细模式（显示计算过程）
```bash
python3 verify_fifo.py AAPL --verbose
```

### 5. 验证多个股票
```bash
python3 verify_fifo.py AAPL TSLA GOOGL
```

### 6. 验证前10个交易最多的股票
```bash
python3 verify_fifo.py --top 10
```

## 📝 常用命令

### 验证持仓ID
```bash
python3 verify_positions.py 1234
```

### 生成人工计算模板
```bash
python3 compare_calculations.py --template my_calculations.csv
```

### 对比人工计算结果
```bash
python3 compare_calculations.py my_calculations.csv
```

## ✅ 验证检查清单

使用工具验证时，请确认以下项目：

### 1. FIFO顺序 ✓
- [ ] 最早的买入交易被最先匹配
- [ ] 没有跳过任何买入交易
- [ ] 匹配顺序严格按照时间

### 2. 数量匹配 ✓
- [ ] 买入数量 = 卖出数量（对于已平仓）
- [ ] 部分成交正确分割
- [ ] 所有持仓数量之和 = 匹配的交易数量

### 3. 手续费分配 ✓
- [ ] 完整匹配：手续费完全分配到持仓
- [ ] 部分匹配：手续费按比例分配
- [ ] 公式：(匹配数量 / 交易总数量) × 总手续费

### 4. 盈亏计算 ✓
- [ ] 公式：(出场价 - 进场价) × 数量
- [ ] 净盈亏 = 盈亏 - 进场费 - 出场费
- [ ] 盈亏率 = 净盈亏 / (进场价 × 数量) × 100%

### 5. 价格匹配 ✓
- [ ] 进场价 = 对应买入交易的成交价
- [ ] 出场价 = 对应卖出交易的成交价
- [ ] 价格未被平均或修改

## 🔍 典型验证场景

### 场景1：简单完整匹配
```
交易：买入100 → 卖出100
预期：生成1个持仓(100股)
```

### 场景2：部分卖出
```
交易：买入100 → 卖出60
预期：生成1个持仓(60股)，剩余40股未平仓
```

### 场景3：多次卖出
```
交易：买入100 → 卖出60 → 卖出40
预期：生成2个持仓(60股 + 40股)
```

### 场景4：多买一卖 (FIFO关键场景)
```
交易：买入50@$100 → 买入50@$110 → 卖出100@$130
预期：生成2个持仓
  - 持仓1: 50股 @ $100→$130 (先买先出)
  - 持仓2: 50股 @ $110→$130
```

## ⚠️ 常见问题

### Q: "找不到数据库"
**A**: 确保在 `verification/` 目录下运行命令

### Q: "没有交易记录"
**A**:
1. 检查股票代码拼写（区分大小写）
2. 使用 `--list` 查看所有可用股票

### Q: 显示"不匹配"
**A**:
1. 检查是否手动修改过数据库
2. 查看详细模式了解差异: `--verbose`
3. 如果是真实问题，请记录并报告

### Q: 如何验证复杂场景？
**A**:
1. 先用 `--list` 找到有多次交易的股票
2. 使用 `--verbose` 查看详细匹配过程
3. 参考 `examples/sample_verification.txt`

## 📚 更多信息

- 完整文档：`README.md`
- 示例输出：`examples/sample_verification.txt`
- 主工程：`../README.md`
- FIFO实现：`../src/matchers/symbol_matcher.py`

## 💡 小贴士

1. **从简单案例开始**: 先验证交易次数少的股票
2. **使用详细模式**: 遇到问题时加上 `--verbose`
3. **对比示例**: 参考 `examples/` 中的示例输出
4. **批量验证**: 使用 `--top N` 一次性验证多个股票
5. **保存输出**: 使用 `> output.txt` 保存验证结果

## 🎯 推荐验证流程

```bash
# 步骤1: 查看可用股票
python3 verify_fifo.py --list

# 步骤2: 选择一个简单的股票(交易次数少)验证
python3 verify_fifo.py FIG

# 步骤3: 如果通过，验证一个复杂的股票
python3 verify_fifo.py TSLL --verbose

# 步骤4: 批量验证前10个股票
python3 verify_fifo.py --top 10

# 步骤5: 如果有疑问，检查特定持仓
python3 verify_positions.py 1234 --full
```

---

**验证快乐！** 🎉

如果发现任何问题，请记录以下信息：
- 股票代码
- 验证输出
- 预期结果vs实际结果
- 数据库状态（是否被修改过）

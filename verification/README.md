# 交易系统验证工具

独立的验证工具集，用于人工检查和验证交易系统的核心计算逻辑，特别是FIFO（先进先出）匹配算法。

## 📁 目录结构

```
verification/
├── README.md                    # 本文件
├── __init__.py                  # Python包标识
├── verify_fifo.py              # FIFO匹配验证工具（核心）
├── verify_positions.py          # 持仓数据验证工具
├── compare_calculations.py      # 计算结果对比工具
└── examples/                    # 示例输出
    └── sample_verification.txt
```

## 🎯 工具用途

### 1. verify_fifo.py - FIFO匹配验证
**核心功能**：验证交易的FIFO（先进先出）匹配逻辑

**适用场景**：
- 验证某个股票的所有交易是否按FIFO正确匹配
- 追踪交易序列的详细匹配过程
- 检查部分成交、多次买卖的复杂场景
- 人工审核系统计算的持仓成本和盈亏

**验证项目**：
- ✅ FIFO顺序（最早买入最先匹配）
- ✅ 数量匹配（部分成交正确处理）
- ✅ 价格匹配（进场/出场价格正确）
- ✅ 手续费分配（按比例分配）
- ✅ 盈亏计算（公式正确）
- ✅ 净盈亏（扣除手续费）
- ✅ 持仓周期（天数计算）
- ✅ 盈亏百分比（相对投入成本）

### 2. verify_positions.py - 持仓验证
快速查看特定持仓ID的详细信息和来源交易

### 3. compare_calculations.py - 计算对比
将外部计算结果（如Excel）与数据库中的持仓进行对比

## 🚀 快速开始

### 前置条件

确保主工程的数据库已经存在：
- 数据库位置：`../data/tradingcoach.db`
- 必须已完成交易导入和FIFO匹配

### 基本使用

```bash
# 进入验证工具目录
cd verification

# 验证单个股票的FIFO匹配
python verify_fifo.py AAPL

# 详细模式（显示每一步匹配）
python verify_fifo.py AAPL --verbose

# 导出HTML报告
python verify_fifo.py AAPL --export report.html

# 验证多个股票
python verify_fifo.py AAPL TSLA GOOGL

# 验证交易最多的前N个股票
python verify_fifo.py --top 10
```

## 📖 详细使用指南

### verify_fifo.py 使用说明

#### 命令行参数

```bash
python verify_fifo.py [SYMBOL...] [OPTIONS]

位置参数:
  SYMBOL                股票代码（可指定多个）

可选参数:
  -h, --help            显示帮助信息
  -v, --verbose         详细模式（显示每一步匹配过程）
  -d, --debug           调试模式（显示完整对象属性）
  --top N               验证交易最多的前N个股票
  --all                 验证所有股票（慎用！）
  --export FILE         导出报告到文件（支持.txt/.html）
  --compare             对比模式（显示人工计算建议）
  --show-trades         显示完整交易列表
  --show-positions      显示完整持仓列表
```

#### 输出说明

**1. 交易序列表**
```
时间                  方向        数量    价格      手续费    累计持仓
2024-10-01 09:30:00  买入        100    $50.00    $2.00    +100
2024-10-02 10:15:00  买入        50     $52.00    $1.50    +150
2024-10-03 14:20:00  卖出        120    $55.00    $2.40    +30
```
- 显示所有交易按时间顺序排列
- 累计持仓列显示净持仓变化

**2. FIFO匹配过程**
```
匹配 #1:
  开仓交易: 买入 100 @ $50.00 (2024-10-01)
  平仓交易: 卖出 120 @ $55.00 (2024-10-03)
  匹配数量: 100 股

  计算详情:
    进场价格: $50.00
    出场价格: $55.00
    进场手续费: $2.00 (100/100 * $2.00)
    出场手续费: $2.00 (100/120 * $2.40)
    盈亏: $500.00
    净盈亏: $496.00
    盈亏率: 9.92%
```
- 显示每个持仓如何从交易中匹配生成
- 详细的计算过程和公式

**3. 数据库对比**
```
Position ID  数量   进场价   出场价   净盈亏      ✓验证
1234         100   $50.00  $55.00  $496.00    ✓ 匹配
1235          20   $52.00  $55.00   $59.00    ✓ 匹配
```
- 对比人工计算与数据库记录
- 标记任何不一致

**4. 验证结果**
```
✅ 通过 / ❌ 失败
- FIFO顺序: ✓
- 数量匹配: ✓
- 手续费分配: ✓
- 盈亏计算: ✓
```

### verify_positions.py 使用说明

```bash
# 验证特定持仓ID
python verify_positions.py 1234

# 验证多个持仓
python verify_positions.py 1234 1235 1236

# 显示完整交易链
python verify_positions.py 1234 --full-chain
```

### compare_calculations.py 使用说明

```bash
# 对比CSV文件中的人工计算
python compare_calculations.py manual_calc.csv

# CSV格式要求:
# symbol,quantity,entry_price,exit_price,expected_pnl
# AAPL,100,50.00,55.00,496.00
```

## 📊 人工验证检查清单

使用工具进行人工验证时，请检查以下项目：

### 1. FIFO顺序检查
- [ ] 最早的买入交易被最先匹配
- [ ] 卖出交易按到达顺序匹配买入队列
- [ ] 不存在"跳过"某笔买入的情况

### 2. 数量匹配检查
- [ ] 完整匹配：买入100，卖出100 → 生成1个持仓（100股）
- [ ] 部分卖出：买入100，卖出60 → 生成1个持仓（60股），剩余40在队列
- [ ] 多次卖出：买入100，卖出60，卖出40 → 生成2个持仓（60+40股）
- [ ] 多买一卖：买入50+50，卖出100 → 生成2个持仓（50+50股）

### 3. 价格计算检查
- [ ] 进场价格 = 对应买入交易的成交价
- [ ] 出场价格 = 对应卖出交易的成交价
- [ ] 价格未被平均或修改

### 4. 手续费分配检查
对于部分成交，手续费应按比例分配：
```
公式: 分配手续费 = (匹配数量 / 交易总数量) × 交易总手续费

示例:
交易: 买入100股，手续费$10
匹配1: 60股 → 手续费 = 60/100 × $10 = $6.00
匹配2: 40股 → 手续费 = 40/100 × $10 = $4.00
```

### 5. 盈亏计算检查
```
做多持仓:
realized_pnl = (exit_price - entry_price) × quantity
net_pnl = realized_pnl - entry_fee - exit_fee
net_pnl_pct = (net_pnl / (entry_price × quantity)) × 100

做空持仓:
realized_pnl = (entry_price - exit_price) × quantity
```

### 6. 持仓周期检查
- [ ] holding_period_days = (close_date - open_date).days
- [ ] 跨月、跨年计算正确

### 7. 边界情况检查
- [ ] 同一天多次买卖（按时间顺序FIFO）
- [ ] 零手续费交易
- [ ] 极小价格差异（如期权）
- [ ] 大数量交易（如港股以手为单位）

## 🔍 常见问题排查

### Q1: 工具报错"找不到数据库"
**A**: 确保在`verification/`目录下运行工具，数据库路径是相对的`../data/tradingcoach.db`

### Q2: 显示"没有交易记录"
**A**: 确认：
1. 股票代码拼写正确（区分大小写）
2. 该股票已有交易记录
3. 使用`python verify_fifo.py --list`查看所有可用股票

### Q3: 计算结果不匹配
**A**: 可能原因：
1. 数据库中的数据已被修改
2. FIFO匹配逻辑与预期不同（如期权vs股票）
3. 手续费四舍五入差异

### Q4: 部分成交验证失败
**A**: 检查：
1. TradeQuantity记录是否正确分配
2. 手续费比例分配是否精确到小数点2位
3. 是否存在多次部分成交

## 📝 验证案例示例

### 案例1：简单的完整匹配

**交易序列：**
1. 2024-01-01: 买入100股 @ $50.00
2. 2024-01-10: 卖出100股 @ $55.00

**预期结果：**
- 生成1个持仓
- 进场价: $50.00
- 出场价: $55.00
- 盈亏: $500.00 (未扣费)

### 案例2：部分成交

**交易序列：**
1. 2024-01-01: 买入100股 @ $50.00, 手续费$10.00
2. 2024-01-05: 卖出60股 @ $55.00, 手续费$6.00
3. 2024-01-10: 卖出40股 @ $54.00, 手续费$4.00

**预期结果：**
- 生成2个持仓
- 持仓1: 60股, $50.00→$55.00, 手续费$6.00+$6.00=$12.00
- 持仓2: 40股, $50.00→$54.00, 手续费$4.00+$4.00=$8.00

### 案例3：多买一卖

**交易序列：**
1. 2024-01-01: 买入50股 @ $100.00
2. 2024-01-05: 买入50股 @ $110.00
3. 2024-01-10: 卖出100股 @ $130.00

**预期结果（FIFO）：**
- 生成2个持仓
- 持仓1: 50股, $100.00→$130.00 (先买先出)
- 持仓2: 50股, $110.00→$130.00

## 🛠 开发和扩展

### 添加新的验证工具

1. 在`verification/`目录创建新的Python文件
2. 导入主工程模块：
```python
import sys
sys.path.insert(0, '..')
from src.models.base import init_database, get_session
```
3. 连接数据库：
```python
DB_PATH = '../data/tradingcoach.db'
init_database(f'sqlite:///{DB_PATH}')
```

### 自定义输出格式

修改`verify_fifo.py`中的格式化函数：
- `format_trade_table()` - 交易序列表格
- `format_matching_detail()` - 匹配过程详情
- `format_verification_result()` - 验证结果

## 📚 相关文档

- 主工程README: `../README.md`
- FIFO匹配实现: `../src/matchers/symbol_matcher.py`
- 单元测试: `../tests/unit/test_symbol_matcher.py`
- PRD文档: `../project_docs/PRD.md`

## 🤝 贡献指南

欢迎改进验证工具！

添加新功能时：
1. 保持工具独立性（不修改主工程代码）
2. 提供清晰的使用说明
3. 添加示例输出到`examples/`目录
4. 更新本README

## 📄 许可证

与主工程相同
